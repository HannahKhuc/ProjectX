<!DOCTYPE html>
<html lang="en">
<head>
	<title> cartpagev_1</title>
    <meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
	  
	<script src="https://www.gstatic.com/firebasejs/5.9.2/firebase.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
		apiKey: "AIzaSyDbL92JRSdB3V1OT7-iMFYytHbxq-7cs3s",
		authDomain: "hannahproject-9a1b1.firebaseapp.com",
		databaseURL: "https://hannahproject-9a1b1.firebaseio.com",
		projectId: "hannahproject-9a1b1",
		storageBucket: "hannahproject-9a1b1.appspot.com",
		messagingSenderId: "973464007710"
	  };
	  firebase.initializeApp(config);
	 // Get a reference to the database service
	  var database = firebase.database();	
	</script>
    <link rel="stylesheet" href="./test.css">                                       
</head>                                         
<body>

    <table id="results" class="results">    
        <th> Store </th>
        <th> Item Name </th>
        <th> Picture </th>
        <th> Price </th>
        <th> Quantity </th>
        <th> Subtotal </th>
    </table>   
    <button id="checkoutButton" type="submit" onclick="window.location.href='checkout.html'"> Checkout! </button>
    <div id="summary" class="summary"> </div>
    
    <script>     
        firebase.auth().onAuthStateChanged(function(user) {
            DisplayCart(user.uid);
        });
        
         // after the user examines the order, and items
         // they will click checkout
        checkoutButton.addEventListener("click",                               
        function(e){ 
            CreateOrder();   
        })
    
        //when you checkout, 
        //copy everything from cart, and create an order object
        function CreateOrder() {
          firebase.auth().onAuthStateChanged(function(user) {
           var dbref = firebase.database().ref("users/"+user.uid+"/cart");
           dbref.once("value", function(snap) {    
             list = snap.val();
             console.log (list);
             
             //var orderID = firebase.database().ref('users/'+user.uid+"/orders").push(
             //list).getKey();             
             //DisplayOrder(user.uid, "LbAafawi6B9dATZbWQS")
               
             console.log("Total is $" + localStorage.getItem("total"));
             var sum = document.getElementById("summary");
             sum.innerHTML = "Checkout Successful. Your Total is $" + total;
             
           })
          });
         }
      
        //read the cart from the database
        //display everything on the cart 
         function DisplayCart(uid){ 
            localStorage.setItem("total", 0);
            var dbref = firebase.database().ref("users/"+uid+"/cart/");
            dbref.once("value", function(snap) {    
                list = snap.val();
                for (let x in list){
                    let quantity = list[x];              
                    var promise = firebase.database().ref("products/"+ x + "/").once("value", function(snap){
                        item=snap.val();
                        console.log(item);
                        DisplayItem(item["name"], item["price"], item["store"], quantity);
                })
             }
           })
         }
         
        //output all the item information 
        //use a basic table
        function DisplayItem(name, price, store, quantity){     
            results = document.getElementById("results");
            var itemRow = document.createElement("tr");
            results.appendChild(itemRow);
            
            var itemCol = document.createElement("td");
            var text = document.createTextNode(store);
            itemCol.appendChild(text);
            itemRow.appendChild(itemCol);
            
            var itemCol = document.createElement("td");
            var text = document.createTextNode(name);
            itemCol.appendChild(text);
            itemRow.appendChild(itemCol);
            
            var itemCol = document.createElement("td");
            var pic = document.createElement("img")
            pic.setAttribute("src", "./images/"+name+".jpg")
            pic.setAttribute("width", "100");
            pic.setAttribute("height", "100");
            itemCol.appendChild(pic);
            itemRow.appendChild(itemCol);
            
            var itemCol = document.createElement("td");
            var text = document.createTextNode("$"+price);
            itemCol.appendChild(text);
            itemRow.appendChild(itemCol);
            
            var itemCol = document.createElement("td");
            var text = document.createTextNode(quantity);
            itemCol.appendChild(text);
            itemRow.appendChild(itemCol);
            
            var itemCol = document.createElement("td");
            subtotal = price*quantity;
            total = parseInt(localStorage.getItem("total"))+subtotal;
            console.log(total);
            localStorage.setItem("total", total);
            var text = document.createTextNode("$" + subtotal);
            itemCol.appendChild(text);
            itemRow.appendChild(itemCol);
            
            
            //var text = document.createTextNode(store + ": " + name + ", $" 
             //                                  + price + ", " + quantity + " units." //+
             //                                  " Subtotal is $" + price*quantity);

        }
    </script>
  
    <script src="create_user.js"></script>
    <script src="setup_firebase_hannah.js"></script>

  </body>
</html>

